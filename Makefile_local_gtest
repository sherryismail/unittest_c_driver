# In this MakeFile, gtest and gmock are compiled as static libraries

HOME	=	/home/vagrant
GTEST_DIR = $(HOME)/googletest/googletest
GTEST_LIB_DIR = .#$(HOME)/googletest/build/lib/
GMOCK_DIR = $(HOME)/googletest/googlemock

CPPFLAGS += -isystem $(GTEST_DIR)/include -isystem $(GMOCK_DIR)/include -I$(HOME)/dev/SW/SOC/Public -I$(HOME)/dev/SW/Host/linux_apps/unittest -I$(HOME)/dev/SW/Public

CXXFLAGS += -g -Wall -Wextra -pthread -std=c++11

GTEST_LIBS = libgtest.a libgtest_main.a libgmock.a libgmock_main.a

TESTS = UnitTest

GTEST_HEADERS = $(GTEST_DIR)/include/gtest/*.h \
                $(GTEST_DIR)/include/gtest/internal/*.h

GMOCK_HEADERS = $(GMOCK_DIR)/include/gmock/*.h \
                $(GMOCK_DIR)/include/gmock/internal/*.h \
                $(GTEST_HEADERS)
                
all: $(GTEST_LIBS) $(TESTS) main

clean:
	rm -f $(GTEST_LIBS) $(TESTS) *.o
	
GTEST_SRCS_ = $(GTEST_DIR)/src/*.cc $(GTEST_DIR)/src/*.h $(GTEST_HEADERS)
GMOCK_SRCS_ = $(GMOCK_DIR)/src/*.cc $(GMOCK_HEADERS)

gtest-all.o: $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
	$(GTEST_DIR)/src/gtest-all.cc
	
gtest_main.o: $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
		$(GTEST_DIR)/src/gtest_main.cc

gmock-all.o : $(GMOCK_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) -I$(GMOCK_DIR) $(CXXFLAGS) \
            -c $(GMOCK_DIR)/src/gmock-all.cc

gmock_main.o : $(GMOCK_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) -I$(GMOCK_DIR) $(CXXFLAGS) \
            -c $(GMOCK_DIR)/src/gmock_main.cc
            
libgtest.a : gtest-all.o
	$(AR) $(ARFLAGS) $@ $^

libgtest_main.a : gtest-all.o gtest_main.o
	$(AR) $(ARFLAGS) $@ $^

libgmock.a : gmock-all.o
	$(AR) $(ARFLAGS) $@ $^

libgmock_main.a : gmock_main.o
	$(AR) $(ARFLAGS) $@ $^
	
FakeServices.o: FakeServices.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c FakeServices.cpp
	
CallingServices.o: $(HOME)/dev/SW/SOC/tx_trf372017_driver/CallingServices.c
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(HOME)/dev/SW/SOC/tx_trf372017_driver/CallingServices.c

# This is the test for NMSApiCivetAdapter
UnitTest.o : UnitTest.cpp $(GTEST_HEADERS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c UnitTest.cpp
	
UnitTest : UnitTest.o $(GTEST_LIBS) CallingServices.o FakeServices.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -L$(GTEST_LIB_DIR) -lpthread -lgtest_main $^ -o $@


# This is the main program that runs all the tests

main.o: main.cpp $(GMOCK_HEADERS) $(GTEST_LIBS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c main.cpp

main: main.o \
      $(GTEST_LIBS) CallingServices.o FakeServices.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -L$(GTEST_LIB_DIR) -lpthread -lgmock \
	$^ -o $@
